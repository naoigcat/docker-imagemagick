name: Bump Version

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  bump:
    runs-on: ubuntu-22.04
    steps:
      -
        name: Checkout
        uses: actions/checkout@v6
        with:
          ssh-key: ${{ secrets.SSH_KEY }}
          fetch-depth: 0
      -
        name: Get tags
        run: |
          git ls-remote --tags https://github.com/ImageMagick/ImageMagick.git |
          grep -v '\^{}$' |
          awk -f <(cat - <<-'SCRIPT'
          {
            split($2,refs,"/")
            split(refs[3],versions,".")
            split(versions[3],patches,"-")
            print refs[3],versions[1],versions[2],patches[1],patches[2]
          }
          SCRIPT
          ) |
          sort -k 2,4 -k 5n |
          sed -n "/$(git tag --sort=-authordate | head -n1)/,\$p" |
          head -n 2 |
          tail -n 1 |
          awk '{print $1}' |
          echo IM_VERSION=$(cat -) | tee /dev/stderr >> $GITHUB_ENV
      -
        name: Compute tarball SHA256
        run: |
          set -euo pipefail
          URL="https://github.com/ImageMagick/ImageMagick/archive/refs/tags/${IM_VERSION}.tar.gz"
          curl -fsSL "$URL" -o /tmp/imagemagick.tar.gz
          IM_TARBALL_SHA256=$(sha256sum /tmp/imagemagick.tar.gz | awk '{print $1}')
          echo "IM_TARBALL_SHA256=${IM_TARBALL_SHA256}" | tee /dev/stderr >> "$GITHUB_ENV"
      -
        name: Bump
        run: |
          set -euo pipefail
          sed -i "s/^ARG IM_VERSION=.*/ARG IM_VERSION=${IM_VERSION}/" Dockerfile
          sed -i "s/^ARG IM_TARBALL_SHA256=.*/ARG IM_TARBALL_SHA256=${IM_TARBALL_SHA256}/" Dockerfile
          if ! git diff --exit-code
          then
            git config --global user.name "github-actions[bot]"
            git config --global user.email "github-actions[bot]@users.noreply.github.com"
            git commit -am "Bump version to ${IM_VERSION}"
            git tag "${IM_VERSION}"
            git push
            git push --tags
          fi
